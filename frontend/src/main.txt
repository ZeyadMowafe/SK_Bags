import React, { useState, useEffect, useRef } from 'react';
import Header from './components/Header';
import ProductCard from './components/ProductCard';
import CartModal from './components/CartModal';
import CheckoutModal from './components/CheckoutModal';
import ProductModal from './components/ProductModal';
import Footer from './components/Footer';
import { apiService } from './services/api';

const MainApp = () => {
  const [products, setProducts] = useState([]);
  const [cart, setCart] = useState([]);
  const [showCart, setShowCart] = useState(false);
  const [showCheckout, setShowCheckout] = useState(false);
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [customerInfo, setCustomerInfo] = useState({
    name: '',
    email: '',
    phone: '',
    address: ''
  });
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  
  const productsRef = useRef(null);
  const aboutRef = useRef(null);
  const contactRef = useRef(null);

  // Fetch products on component mount
  useEffect(() => {
    const fetchProducts = async () => {
      try {
        setIsLoading(true);
        const productsData = await apiService.getProducts();
        setProducts(productsData);
      } catch (error) {
        console.error('Error fetching products:', error);
        // Fallback to dummy data
        setProducts([
          {
            id: 1,
            name: "شنطة جلد طبيعي",
            description: "شنطة أنيقة مصنوعة من الجلد الطبيعي عالي الجودة",
            price: 299.99,
            image_url: "https://images.unsplash.com/photo-1548036328-c9fa89d128fa?w=400",
            category: "شنط يد",
            stock_quantity: 10
          },
          {
            id: 2,
            name: "شنطة كروس باج",
            description: "شنطة عملية ومريحة للاستخدام اليومي",
            price: 199.99,
            image_url: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400",
            category: "شنط كروس",
            stock_quantity: 15
          },
          {
            id: 3,
            name: "شنطة كلاتش",
            description: "شنطة أنيقة للمناسبات الخاصة",
            price: 399.99,
            image_url: "https://images.unsplash.com/photo-1594223274512-ad4803739b7c?w=400",
            category: "شنط كلاتش",
            stock_quantity: 8
          },
          {
            id: 4,
            name: "شنطة سفر",
            description: "شنطة متينة ومناسبة للسفر",
            price: 499.99,
            image_url: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400",
            category: "شنط سفر",
            stock_quantity: 5
          },
          {
            id: 5,
            name: "شنطة ظهر",
            description: "شنطة ظهر عملية ومريحة",
            price: 249.99,
            image_url: "https://images.unsplash.com/photo-1548036328-c9fa89d128fa?w=400",
            category: "شنط ظهر",
            stock_quantity: 12
          },
          {
            id: 6,
            name: "شنطة صغيرة",
            description: "شنطة صغيرة وأنيقة للمناسبات",
            price: 179.99,
            image_url: "https://images.unsplash.com/photo-1594223274512-ad4803739b7c?w=400",
            category: "شنط صغيرة",
            stock_quantity: 7
          }
        ]);
      } finally {
        setIsLoading(false);
      }
    };

    fetchProducts();
  }, []);

  const addToCart = (product) => {
    setCart(prevCart => {
      const existingItem = prevCart.find(item => item.id === product.id);
      if (existingItem) {
        return prevCart.map(item =>
          item.id === product.id
            ? { ...item, quantity: item.quantity + 1 }
            : item
        );
      } else {
        return [...prevCart, { ...product, quantity: 1 }];
      }
    });
    
    // أنيميشن إضافة للسلة
    const cartBtn = document.querySelector('.cart-button');
    if (cartBtn) {
      cartBtn.classList.add('animate-ping');
      setTimeout(() => {
        cartBtn.classList.remove('animate-ping');
      }, 500);
    }
  };

  const updateQuantity = (productId, newQuantity) => {
    if (newQuantity <= 0) {
      removeFromCart(productId);
      return;
    }
    
    setCart(prevCart =>
      prevCart.map(item =>
        item.id === productId
          ? { ...item, quantity: newQuantity }
          : item
      )
    );
  };

  const removeFromCart = (productId) => {
    setCart(prevCart => prevCart.filter(item => item.id !== productId));
  };

  const getTotalPrice = () => {
    return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
  };

  const handleCheckout = async () => {
    try {
      const orderData = {
        customer_info: customerInfo,
        items: cart.map(item => ({
          product_id: item.id,
          quantity: item.quantity,
          price: item.price
        })),
        total_amount: getTotalPrice()
      };

      await apiService.createOrder(orderData);
      
      // Clear cart and customer info
      setCart([]);
      setCustomerInfo({ name: '', email: '', phone: '', address: '' });
      setShowCheckout(false);
      setShowCart(false);
      
      alert('تم إرسال طلبك بنجاح! سنتواصل معك قريباً.');
    } catch (error) {
      console.error('Error creating order:', error);
      alert('حدث خطأ أثناء إرسال الطلب. يرجى المحاولة مرة أخرى.');
    }
  };

  const cartCount = cart.reduce((total, item) => total + item.quantity, 0);

  return (
    <div className="min-h-screen bg-white">
      <Header
        cartCount={cartCount}
        toggleCart={() => setShowCart(true)}
        toggleMenu={() => setIsMenuOpen(!isMenuOpen)}
        scrollToProducts={() => productsRef.current?.scrollIntoView({ behavior: 'smooth' })}
        scrollToAbout={() => aboutRef.current?.scrollIntoView({ behavior: 'smooth' })}
        scrollToContact={() => contactRef.current?.scrollIntoView({ behavior: 'smooth' })}
      />

      {/* Hero Section */}
      <section 
        id="home"
        className="relative min-h-screen bg-gradient-to-r from-white via-gray-100 to-white text-black py-20 overflow-hidden"
      >
        {/* Geometric patterns */}
        <div className="absolute top-0 left-0 w-full h-full opacity-5">
          <div className="absolute top-20 left-20 w-64 h-64 border-2 border-black rounded-full"></div>
          <div className="absolute bottom-20 right-20 w-48 h-48 border-2 border-black"></div>
          <div className="absolute top-1/2 left-1/4 w-32 h-32 border-2 border-black rotate-45"></div>
        </div>
        
        {/* Background image */}
        <div className="absolute inset-0">
          <div 
            className="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-10"
            style={{
              backgroundImage: `url('https://images.unsplash.com/photo-1553062407-98eeb64c6a62?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2000&q=80')`
            }}
          />
        </div>

        {/* Content */}
        <div className="relative z-10 container mx-auto px-4 flex items-center min-h-screen">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-center w-full">
            
            {/* Text */}
            <div className="text-center lg:text-right order-2 lg:order-1 mt-8 lg:mt-0 animate-fade-in-up">
              <h1 className="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold mb-4 lg:mb-6 leading-tight">
                HANDMADE
                <span className="block text-black font-light mt-2 border-b-4 border-black pb-2">BAGS</span>
              </h1>
              <p className="text-lg sm:text-xl lg:text-2xl mb-6 lg:mb-8 leading-relaxed max-w-2xl mx-auto lg:mx-0 px-4 lg:px-0 text-gray-700">
                High-quality handmade bags crafted with care and precision by skilled artisans
              </p>
              <div className="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center lg:justify-start px-4 lg:px-0">
                <a
                  href="#products"
                  className="bg-black text-white px-6 sm:px-8 py-3 rounded-none font-bold hover:bg-gray-800 transition-all duration-300 transform hover:scale-105 shadow-lg text-center border-2 border-black uppercase tracking-wider"
                  onClick={(e) => {
                    e.preventDefault();
                    productsRef.current?.scrollIntoView({ behavior: 'smooth' });
                  }}
                >
                  Shop Now
                </a>
                <button 
                  className="border-2 border-black text-black px-6 sm:px-8 py-3 rounded-none font-bold hover:bg-black hover:text-white transition-all duration-300 transform hover:scale-105 uppercase tracking-wider"
                  onClick={() => aboutRef.current?.scrollIntoView({ behavior: 'smooth' })}
                >
                  Learn More
                </button>
              </div>
            </div>

            {/* Product image */}
            <div className="flex justify-center lg:justify-start order-1 lg:order-2 mt-4 lg:mt-0 animate-float">
              <div className="relative">
                {/* Main image */}
                <img
                  src="https://images.unsplash.com/photo-1584917865442-de89df76afd3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80"
                  alt="Handmade leather bag"
                  className="w-64 h-64 sm:w-80 sm:h-80 lg:w-96 lg:h-96 object-cover shadow-2xl border-4 border-black transform rotate-3 hover:rotate-0 transition-transform duration-500"
                />
                
                {/* "Hand Made" badge */}
                <div className="absolute -top-2 sm:-top-4 -right-2 sm:-right-4 bg-black text-white px-2 sm:px-4 py-1 sm:py-2 font-bold text-xs sm:text-sm shadow-lg transform rotate-12 hover:rotate-0 transition-transform duration-300 uppercase tracking-wide">
                  ✋ Hand Made
                </div>

                {/* Decorative elements */}
                <div className="absolute -bottom-6 -left-6 w-16 sm:w-24 h-16 sm:h-24 bg-black rounded-full blur-sm hidden sm:block animate-ping-slow" />
                <div className="absolute -top-6 sm:-top-8 -left-6 sm:-left-8 w-12 sm:w-16 h-12 sm:h-16 bg-gray-800 rounded-full blur-sm hidden sm:block animate-ping-slow delay-1000" />
              </div>
            </div>
          </div>
        </div>

        {/* Decorative elements */}
        <div className="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-white/20 to-transparent" />
        
        {/* Floating small icons - hidden on mobile */}
        <div className="absolute top-20 left-4 sm:left-10 animate-bounce delay-100 hidden sm:block">
          <div className="w-3 sm:w-4 h-3 sm:h-4 bg-black rounded-full opacity-60" />
        </div>
        <div className="absolute top-32 sm:top-40 right-4 sm:right-20 animate-bounce delay-300 hidden sm:block">
          <div className="w-4 sm:w-6 h-4 sm:h-6 bg-gray-800 rounded-full opacity-40" />
        </div>
        <div className="absolute bottom-32 sm:bottom-40 left-4 sm:left-20 animate-bounce delay-500 hidden sm:block">
          <div className="w-4 sm:w-5 h-4 sm:h-5 bg-gray-600 rounded-full opacity-50" />
        </div>
        
        {/* Scroll indicator */}
        <div className="absolute bottom-10 left-1/2 transform -translate-x-1/2 animate-bounce">
          <div className="w-6 h-10 border-2 border-black rounded-full flex justify-center">
            <div className="w-1 h-3 bg-black rounded-full mt-2 animate-scroll"></div>
          </div>
        </div>
      </section>

      {/* Products Section */}
      <section id="products" ref={productsRef} className="py-12 sm:py-16 bg-gray-100 border-t border-gray-300">
        <div className="container mx-auto px-4">
          <h2 className="text-3xl sm:text-4xl font-bold text-center mb-8 sm:mb-12 text-black uppercase tracking-wide border-b-2 border-black pb-2 inline-block mx-auto animate-fade-in">
            Our Products
          </h2>
          
          {isLoading ? (
            <div className="flex justify-center items-center h-64">
              <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-black"></div>
            </div>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8">
              {products.map((product, index) => (
                <div 
                  key={product.id} 
                  className="animate-fade-in-up bg-white border-2 border-gray-800 transform hover:scale-105 transition-all duration-300"
                  style={{ animationDelay: `${index * 0.1}s` }}
                >
                  <ProductCard
                    product={product}
                    onAddToCart={addToCart}
                    onViewDetails={() => setSelectedProduct(product)}
                  />
                </div>
              ))}
            </div>
          )}
        </div>
      </section>

      {/* About Section */}
      <section id="about" ref={aboutRef} className="bg-white py-12 sm:py-16 border-t border-gray-300">
        <div className="container mx-auto px-4">
          <div className="max-w-4xl mx-auto text-center animate-fade-in">
            <h2 className="text-3xl sm:text-4xl font-bold mb-6 sm:mb-8 text-black uppercase tracking-wide border-b-2 border-black pb-2">من نحن</h2>
            <p className="text-base sm:text-lg text-gray-700 leading-relaxed px-2 sm:px-0">
              نحن متخصصون في صناعة الشنط اليدوية الفريدة والأنيقة. نستخدم أجود أنواع المواد
              ونطبق أحدث التقنيات لضمان الجودة العالية والتصميم المميز. كل قطعة من منتجاتنا
              تحمل بصمة فريدة من الإبداع والأناقة.
            </p>
            
            {/* Decorative line */}
            <div className="mt-8 flex justify-center">
              <div className="w-24 h-0.5 bg-black animate-pulse"></div>
            </div>
            
            {/* Features */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
              <div className="p-6 bg-black text-white rounded-none border-2 border-gray-800 transform hover:scale-105 transition-all duration-300">
                <div className="text-3xl mb-4">🎨</div>
                <h3 className="text-xl font-semibold mb-2">تصميم فريد</h3>
                <p className="text-gray-300">تصاميمنا تحمل بصمة فنية مميزة تناسب جميع الأذواق</p>
              </div>
              
              <div className="p-6 bg-white text-black rounded-none border-2 border-gray-800 transform hover:scale-105 transition-all duration-300">
                <div className="text-3xl mb-4">✋</div>
                <h3 className="text-xl font-semibold mb-2">صناعة يدوية</h3>
                <p className="text-gray-700">كل قطعة تصنع يدوياً بدقة عالية واهتمام بالتفاصيل</p>
              </div>
              
              <div className="p-6 bg-black text-white rounded-none border-2 border-gray-800 transform hover:scale-105 transition-all duration-300">
                <div className="text-3xl mb-4">⭐</div>
                <h3 className="text-xl font-semibold mb-2">جودة عالية</h3>
                <p className="text-gray-300">نستخدم أفضل المواد لضمان المتانة والجودة العالية</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Contact Section */}
      <section id="contact" ref={contactRef} className="bg-gray-100 py-12 sm:py-16">
        <div className="container mx-auto px-4">
          <div className="max-w-4xl mx-auto text-center animate-fade-in">
            <h2 className="text-3xl sm:text-4xl font-bold mb-6 sm:mb-8 text-black uppercase tracking-wide border-b-2 border-black pb-2">اتصل بنا</h2>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 sm:gap-8">
              <div className="p-4 bg-white border-2 border-gray-800 rounded-none transform hover:scale-105 transition-all duration-300">
                <h3 className="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-black">البريد الإلكتروني</h3>
                <p className="text-sm sm:text-base text-gray-700 break-words">info@handmadebags.com</p>
              </div>
              <div className="p-4 bg-black text-white border-2 border-gray-800 rounded-none transform hover:scale-105 transition-all duration-300">
                <h3 className="text-lg sm:text-xl font-semibold mb-3 sm:mb-4">الهاتف</h3>
                <p className="text-sm sm:text-base text-gray-300">+20 123 456 7890</p>
              </div>
              <div className="p-4 bg-white border-2 border-gray-800 rounded-none transform hover:scale-105 transition-all duration-300">
                <h3 className="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-black">العنوان</h3>
                <p className="text-sm sm:text-base text-gray-700">القاهرة، مصر</p>
              </div>
            </div>
            
            {/* Contact form */}
            <div className="mt-12 bg-white border-2 border-gray-800 p-6 rounded-none">
              <h3 className="text-xl font-semibold mb-6 text-black">أرسل لنا رسالة</h3>
              <form className="space-y-4">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <input 
                    type="text" 
                    placeholder="الاسم" 
                    className="p-3 bg-gray-100 text-black rounded-none focus:outline-none focus:ring-2 focus:ring-black border border-gray-400"
                  />
                  <input 
                    type="email" 
                    placeholder="البريد الإلكتروني" 
                    className="p-3 bg-gray-100 text-black rounded-none focus:outline-none focus:ring-2 focus:ring-black border border-gray-400"
                  />
                </div>
                <textarea 
                  placeholder="الرسالة" 
                  rows="4"
                  className="w-full p-3 bg-gray-100 text-black rounded-none focus:outline-none focus:ring-2 focus:ring-black border border-gray-400"
                ></textarea>
                <button 
                  type="submit"
                  className="bg-black text-white px-6 py-3 rounded-none font-bold hover:bg-gray-800 transition-all duration-300 uppercase tracking-wider border-2 border-black"
                >
                  إرسال الرسالة
                </button>
              </form>
            </div>
          </div>
        </div>
      </section>

      <Footer />

      {/* Modals */}
      {showCart && (
        <CartModal
          cart={cart}
          updateQuantity={updateQuantity}
          removeFromCart={removeFromCart}
          getTotalPrice={getTotalPrice}
          onClose={() => setShowCart(false)}
          onCheckout={() => {
            setShowCart(false);
            setShowCheckout(true);
          }}
        />
      )}

      {showCheckout && (
        <CheckoutModal
          customerInfo={customerInfo}
          setCustomerInfo={setCustomerInfo}
          cart={cart}
          getTotalPrice={getTotalPrice}
          onClose={() => setShowCheckout(false)}
          onSubmit={handleCheckout}
        />
      )}

      {selectedProduct && (
        <ProductModal
          product={selectedProduct}
          onClose={() => setSelectedProduct(null)}
          onAddToCart={(product) => {
            addToCart(product);
            setSelectedProduct(null);
          }}
        />
      )}
      
      {/* Custom styles for animations */}
      <style jsx>{`
        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        @keyframes float {
          0% {
            transform: translateY(0px);
          }
          50% {
            transform: translateY(-10px);
          }
          100% {
            transform: translateY(0px);
          }
        }
        @keyframes bounce-slow {
          0%, 100% {
            transform: translateY(0);
          }
          50% {
            transform: translateY(-10px);
          }
        }
        @keyframes ping-slow {
          0% {
            transform: scale(1);
            opacity: 1;
          }
          50% {
            transform: scale(1.5);
            opacity: 0.5;
          }
          100% {
            transform: scale(1);
            opacity: 1;
          }
        }
        @keyframes scroll {
          0% {
            transform: translateY(0);
          }
          50% {
            transform: translateY(5px);
          }
          100% {
            transform: translateY(0);
          }
        }
        .animate-fade-in-up {
          animation: fadeInUp 0.6s ease-out forwards;
        }
        .animate-float {
          animation: float 5s ease-in-out infinite;
        }
        .animate-bounce-slow {
          animation: bounce-slow 2s infinite;
        }
        .animate-ping-slow {
          animation: ping-slow 3s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        .animate-scroll {
          animation: scroll 2s infinite;
        }
        .animate-fade-in {
          animation: fadeInUp 1s ease-out forwards;
        }
      `}</style>
    </div>
  );
};

export default MainApp;